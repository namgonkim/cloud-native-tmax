# 클라우드 개발자 양성과정

## 상용 클라우드를 이용한 어플리케이션 배포
[소스코드](https://github.com/namgonkim/msa-ecommerce-tmax)
* 토이 프로젝트를 통한 msa 어플리케이션 실습
    - 장애처리, 마이크로서비스 분산 추적

## cloud native application
* Cloud Native 필수
    - MicroServices
    - CI/CD
    - DevOps
    - Containers
* 규모가 큰 것에 대해서는 war로 배포

## 장애처리와 마이크로서비스 분산 추적
* 장애가 발생했을 때, 우회해주는 작업을 서킷브레이커(CircuitBreaker)라 한다.
* CircuitBreaker
    - 특정 서비스가 정상적으로 동작하지 않을 경우 다른 기능으로 대체 수행하여 장애를 회피한다.
    - 커넥션에 문제가 발생해서 timeout이 일정 횟수 이상 발생하면 circuit이 오픈되어 서킷브레이커가 작동한다.
```
Service         --->       CircuitBreaker       --->        MicroService
Consumer        <---        Closed              <---

Service         --->       CircuitBreaker       -x->        MicroService
Consumer        <---        Open              
```

### circuit breaker 코드
```java
// user-service
    ...
CircuitBreaker circuitBreaker = circuitBreakerFactory.create("my-circuitbreaker");
// getOrders가 정상적으로 호출되지 않는다면 비어있는 arraylist를 반환시킨다.
ordersList = circuitBreaker.run(() -> orderServiceClient.getOrders(userId),
            throwable -> new ArrayList<>());
    ...
```

## 마이크로서비스 분산 추적
* 트래킹하는 것.
* 분산 추적된 결과를 기록하는 서버
    - zipkin

### Zipkin
* 트위터에서 사용하는 분산 환경의 timing 데이터 수집, 추적 시스템
* Google Drapper에서 발전, 분산환경에서의 시스템 병목현상 파악
* Span
    - 하나의 요청에 사용되는 작업의 단위
* Trace
    - 트리 구조로 이루어진 span tpt
    - 하나의 요청에 대한 같은 Trace ID 발급

```
// docker
docker run -d -p 9411:9411 openzipkin/zipkin

// java
curl -sSL https://zipkin.io/quickstart.sh | bash -s
java -jar zipkin.jar
```
> 집킨은 서버이기 떄문에 실행 후 localhost:9411 로 접속해보면 확인할 수 있다.

### 설정 추가
* zipkin과 sleuth는 설정 추가만으로 작동이 된다. 소스 코드 추가는 특별히 할 필요가 없다.
* pom.xml
```xml
<!-- 서킷브레이커 -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-circuitbreaker-resilience4j</artifactId>
</dependency>
<!-- sleuth -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-sleuth</artifactId>
    <version>3.0.3</version>
</dependency>
<!-- zipkin -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-zipkin</artifactId>
    <version>2.2.8.RELEASE</version>
</dependency>
```
* application.yml
```yaml
spring:
  zipkin:
    base-url: http://localhost:9411
    enabled: true
  # 데이터를 어느정도까지 전달할껀지
  sleuth:
    sampler:
      probability: 1.0
```
